<project name="common schema" default="all" basedir=".">
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="/usr/share/java/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<property name="mysql.user" value="root" />
	<property name="mysql.password" value="" />
	<property name="mysql.socket" value="/tmp/mysql.prime.sock" />

	<property name="mysql.database" value="common_schema" />

	<property name="build.dir" value="build" />
	<property name="dist.dir" value="dist" />
	<property name="tests.dir" value="tests" />
	<property name="tmp.dir" value="ant-tmp" />
	<property name="sql.mysql_51.output.file" value="common_schema_mysql_51.sql" />
	<property name="sql.innodb_plugin.output.file" value="common_schema_innodb_plugin.sql" />
	<property name="sql.percona_server.output.file" value="common_schema_percona_server.sql" />

	<property name="doc.templates.dir" value="doc/templates" />
	<property name="doc.html.dir" value="doc/html" />
	
	<property name="doc.sql.tmp.file" value="doc_sql.txt" />

	<target name="all" depends="build">
	</target>

	<target name="build" depends="revnumber, build_all, build_mysql_51, build_innodb_plugin, build_percona_server">
	</target>

	<target name="clean">
		<delete dir="${build.dir}" />
		<delete dir="${dist.dir}" />
		<delete dir="${tmp.dir}" />
	</target>

	<target name="undeploy">
		<antcall target="exec_mysql_command">
			<param name="mysql_command" value="DROP DATABASE IF EXISTS ${mysql.database}" />
		</antcall>
	</target>

	<target name="revnumber" description="Get the SVN greatest revision number">
		<mkdir dir="${tmp.dir}" />
		<exec dir="." executable="svn" output="ant-tmp/svn_output" failifexecutionfails="false" description="Get SVN info for all files recursively">
			<arg value="info" />
			<arg value="--recursive" />
		</exec>
		<exec dir="." executable="awk" input="ant-tmp/svn_output" outputproperty="svn.revision" failifexecutionfails="false" description="Extract highest revision number">
			<arg value="BEGIN {max=0} /Revision:/ {if ($2 > max) max=$2} END {print max}" />
		</exec>
		<condition property="svn.revision" value="0">
			<not>
				<isset property="svn.revision" />
			</not>
		</condition>
		<delete dir="${tmp.dir}" />
		<tstamp description="To be used as build number" />
		<echo>revision: ${svn.revision}</echo>
	</target>


	<target name="build_all" depends="revnumber">
		<mkdir dir="${build.dir}" />
		<concat destfile="${build.dir}/base_${sql.mysql_51.output.file}">
			<fileset dir="tables/" includes="*.sql" />

			<fileset dir="routines/dependencies/" includes="*.sql" />
			<fileset dir="routines/general/" includes="*.sql" />
			<fileset dir="routines/general_internal/" includes="*.sql" />
			<fileset dir="routines/meta/" includes="*.sql" />
			<fileset dir="routines/privileges/" includes="*.sql" />
			<fileset dir="routines/process/" includes="*.sql" />
			<fileset dir="routines/text/" includes="*.sql" />
			<fileset dir="routines/time/" includes="*.sql" />
			
			<fileset dir="autocache/tables/" includes="*.sql" />
			<fileset dir="autocache/routines/" includes="*.sql" />
			<fileset dir="autocache/views_internal/" includes="*.sql" />
			<fileset dir="autocache/views/" includes="*.sql" />

			<fileset dir="views/schema_analysis/" includes="*.sql" />
			<fileset dir="views/data_dimension/" includes="*.sql" />
			<fileset dir="views/monitoring/" includes="*.sql" />
			<fileset dir="views/process/" includes="*.sql" />
			<fileset dir="views/security/" includes="*.sql" />
		</concat>
		<replace file="${build.dir}/base_${sql.mysql_51.output.file}" token="revision.placeholder" value="${svn.revision}"/>
		<concat destfile="${build.dir}/base_${sql.innodb_plugin.output.file}">
			<fileset dir="routines/innodb_plugin/" includes="*.sql" />
			<fileset dir="views/innodb_plugin/" includes="*.sql" />
		</concat>
		<concat destfile="${build.dir}/base_${sql.percona_server.output.file}">
			<fileset dir="views/percona_server/" includes="*.sql" />
		</concat>
	</target>

	<target name="build_mysql_51" depends="build_all">
		<mkdir dir="${build.dir}" />
		<concat destfile="${build.dir}/${sql.mysql_51.output.file}">
			<fileset file="main_head.sql" />
			<fileset file="${build.dir}/base_${sql.mysql_51.output.file}" />
			<fileset file="main_tail.sql" />
		</concat>
	</target>

	<target name="build_innodb_plugin" depends="build_all">
		<concat destfile="${build.dir}/${sql.innodb_plugin.output.file}">
			<fileset file="main_head.sql" />
			<fileset file="${build.dir}/base_${sql.mysql_51.output.file}" />
			<fileset file="${build.dir}/base_${sql.innodb_plugin.output.file}" />
			<fileset file="main_tail.sql" />		
		</concat>
	</target>

	<target name="build_percona_server" depends="build_all">
		<concat destfile="${build.dir}/${sql.percona_server.output.file}">
			<fileset file="main_head.sql" />
			<fileset file="${build.dir}/base_${sql.mysql_51.output.file}" />
			<fileset file="${build.dir}/base_${sql.innodb_plugin.output.file}" />
			<fileset file="${build.dir}/base_${sql.percona_server.output.file}" />
			<fileset file="main_tail.sql" />		
		</concat>
	</target>

	<target name="dist" depends="clean, build, revnumber, test">
		<mkdir dir="${dist.dir}" />
		<antcall target="dist_file">
			<param name="common_schema_sql_file" value="${sql.mysql_51.output.file}" />
		</antcall>
		<antcall target="dist_file">
			<param name="common_schema_sql_file" value="${sql.innodb_plugin.output.file}" />
		</antcall>
		<antcall target="dist_file">
			<param name="common_schema_sql_file" value="${sql.percona_server.output.file}" />
		</antcall>
		<tar destfile="${dist.dir}/common_schema_doc_r${svn.revision}.tar.gz" basedir="doc/html" compression="gzip" />
	</target>

	<target name="dist_file">
		<propertyregex property="release_filename" input="${common_schema_sql_file}" regexp="(.*).sql" select="\1-r${svn.revision}.sql" />
		<copy file="${build.dir}/${common_schema_sql_file}" tofile="${dist.dir}/${release_filename}" />
	</target>

	<target name="deploy_mysql_51" depends="build_mysql_51">
		<antcall target="deploy_file">
			<param name="common_schema_sql_file" value="${build.dir}/${sql.mysql_51.output.file}" />
		</antcall>
	</target>

	<target name="deploy_innodb_plugin" depends="build_innodb_plugin">
		<antcall target="deploy_file">
			<param name="common_schema_sql_file" value="${build.dir}/${sql.innodb_plugin.output.file}" />
		</antcall>
	</target>

	<target name="deploy_percona_server" depends="build_percona_server">
		<antcall target="deploy_file">
			<param name="common_schema_sql_file" value="${build.dir}/${sql.percona_server.output.file}" />
		</antcall>
	</target>

	<target name="deploy_file">
		<echo>
			Deploying file: ${common_schema_sql_file}
		</echo>
		<antcall target="exec_mysql_file">
			<param name="sql_file" value="${common_schema_sql_file}" />
		</antcall>
	</target>

	<target name="exec_mysql_file">
		<echo>
			Executing SQL file: ${sql_file}
		</echo>
		<exec executable="mysql" input="${sql_file}">
			<arg value="--user=${mysql.user}" />
			<arg value="--password=${mysql.password}" />
			<arg value="--socket=${mysql.socket}" />
		</exec>
	</target>

	<target name="exec_mysql_command">
		<propertyregex property="short.command" input="${mysql_command}"
			regexp="(^.{1,80})" select="\1" casesensitive="false" />

		<echo>
			Executing SQL command: ${short.command}
		</echo>
		<exec executable="mysql">
			<arg value="--user=${mysql.user}" />
			<arg value="--password=${mysql.password}" />
			<arg value="--socket=${mysql.socket}" />
			<arg value="--execute=${mysql_command}" />
		</exec>
	</target>

	<target name="doc">
		<copy file="${doc.templates.dir}/style.css" todir="${doc.html.dir}/css">
		</copy>
		<foreach param="component_doc_filename" target="component_doc">
			<path>
				<fileset dir="${doc.templates.dir}/components">
					<include name="*.html" />
				</fileset>
			</path>
		</foreach>
		<foreach param="generaldoc_filename" target="generaldoc">
			<path>
				<fileset dir="${doc.templates.dir}/general">
					<include name="*.html" />
				</fileset>
			</path>
		</foreach>
		<!--
		<foreach param="routine_group_path" target="routinesdoc">
			<path>
				<dirset dir="${doc.templates.dir}/routines">
			    	<include name="*"/>
				</dirset>
			</path>
		</foreach>
		-->
	</target>
	<target name="component_doc">
		<basename property="doc_basename" file="${component_doc_filename}" />
		<basename property="component_name" file="${component_doc_filename}" suffix=".html" />
		<echo message="Generating documentation for ${component_name} component" />
		<concat destfile="${doc.html.dir}/${doc_basename}">
			<filelist dir="${doc.templates.dir}" files="head.html.template, ${component_doc_filename}, tail.html.template" />
		</concat>
		<replace file="${doc.html.dir}/${doc_basename}" token="pagetitle" value="${component_name}" />
		<replace file="${doc.html.dir}/${doc_basename}" token="pagename" value="${component_name}" />
	</target>
	<target name="generaldoc">
		<basename property="doc_basename" file="${generaldoc_filename}" />
		<basename property="docname" file="${generaldoc_filename}" suffix=".html" />
		<echo message="Generating documentation for ${docname} file" />
		<concat destfile="${doc.html.dir}/${doc_basename}">
			<filelist dir="${doc.templates.dir}" files="head.html.template, ${generaldoc_filename}, tail.html.template" />
		</concat>
		<replace file="${doc.html.dir}/${doc_basename}" token="pagetitle" value="${docname}" />
		<replace file="${doc.html.dir}/${doc_basename}" token="pagename" value="${docname}" />
	</target>
	<target name="routinesdoc">
		<basename property="routine_group_name" file="${routine_group_path}" />
		<propertyregex property="routine_group_name.spaced" input="${routine_group_name}" regexp="_" replace=" ">
		</propertyregex>
		<echo message="Generating documentation for ${routine_group_name}" />
		<concat destfile="${doc.html.dir}/${routine_group_name}.html">
			<filelist dir="${doc.templates.dir}" files="head.html.template" />
			<fileset dir="${doc.templates.dir}/routines/${routine_group_name}">
			</fileset>
			<filelist dir="${doc.templates.dir}/routines" files="routine.tail.html.template" />
			<filelist dir="${doc.templates.dir}" files="tail.html.template" />
		</concat>
		<replace file="${doc.html.dir}/${routine_group_name}.html" token="pagetitle" value="${routine_group_name.spaced}" />
		<replace file="${doc.html.dir}/${routine_group_name}.html" token="pagename" value="${routine_group_name.spaced}" />
	</target>
	
	<target name="doc_sql">
		<mkdir dir="${tmp.dir}" />
		<foreach param="component_doc_filename" target="component_doc_sql">
			<path>
				<fileset dir="${doc.templates.dir}/components">
					<include name="*.html" />
				</fileset>
			</path>
		</foreach>
		<delete dir="${tmp.dir}" />
	</target>
	<target name="component_doc_sql">
		<basename property="doc_basename" file="${component_doc_filename}" />
		<basename property="component_name" file="${component_doc_filename}" suffix=".html" />
		<echo message="Generating documentation for ${component_name} component" />
		<exec executable="html2text">
			<arg value="-ascii"/>
			<arg value="-width"/>
			<arg value="78"/>
			<arg value="-style"/>
			<arg value="pretty"/>
			<arg value="-o"/>
			<arg value="${tmp.dir}/${doc.sql.tmp.file}"/>
			<arg value="${component_doc_filename}"/>
		</exec>
		<replace file="${tmp.dir}/${doc.sql.tmp.file}" token="\" value="\\"/>
		<replace file="${tmp.dir}/${doc.sql.tmp.file}" token="'" value="''"/>
		<loadfile property="doc.sql.text" srcfile="${tmp.dir}/${doc.sql.tmp.file}"></loadfile>
		<antcall target="exec_mysql_command">
			<param name="mysql_command" value="INSERT INTO ${mysql.database}.help VALUES ('${component_name}','${doc.sql.text}')" />
		</antcall> 
	</target>

	<target name="test">
		<echo>Testing</echo>
		<exec executable="bash" dir="${tests.dir}" failonerror="true">
			<arg value="test_all.sh" />
			<arg value="${mysql.user}" />
			<arg value="${mysql.password}" />
			<arg value="${mysql.socket}" />
		</exec>
	</target>
	
	<target name="__test__">
		<loadfile property="f.c" srcfile="/tmp/crc64.sql">
		</loadfile>
		<echo>prop: ${f.c}</echo>
		<propertyregex property="f.c2" input="${f.c}" regexp="@desc (.*)" select="\1">
		</propertyregex>
		<echo>prop2: ---${f.c2}---</echo>
	</target>
</project>